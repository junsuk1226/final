<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.kdt.finalproject.mapper.PayMapper">

<!-- select -->
<select id="poNum_count" parameterType="com.kdt.finalproject.vo.PayVO" resultType="int">
    SELECT COUNT(COALESCE(restNm, 0)) FROM paylog WHERE restNm = #{restNm};
</select>

<select id="kakao_refunt_select" parameterType="String" resultType="com.kdt.finalproject.vo.PayVO">
  	SELECT * FROM paylog where tid = #{tid}
</select>

<select id="order_receipt" parameterType="String" resultType="com.kdt.finalproject.vo.PayVO">
    SELECT * FROM paylog where p_oderId = #{p_oderId}
</select>

<select id="order_list" parameterType="Map" resultType="com.kdt.finalproject.vo.PayVO">
  SELECT * FROM(
		SELECT @RN:=@RN+1 AS rnum,a.* FROM(
      SELECT * FROM paylog
      WHERE m_idx = #{m_idx} and p_status &lt; 2
      <if test="searchType != null and searchType == 0">
				AND foodNm LIKE CONCAT('%', #{searchValue}, '%')
			</if>
			<if test="searchType != null and searchType == 1">
				AND restNm LIKE CONCAT('%', #{searchValue}, '%')
			</if>
			<if test="searchType != null and searchType == 2">
				AND p_date LIKE CONCAT('%', #{searchValue}, '%')
			</if>
    ) a, (SELECT @RN:=0) b
	) c WHERE c.rnum BETWEEN #{begin} AND #{end}
</select>

<select id="order_selected" parameterType="String" resultType="com.kdt.finalproject.vo.PayVO">
    SELECT * FROM paylog WHERE p_idx=#{p_idx}
</select>

<update id="delOrder" parameterType="String">
  UPDATE paylog
  SET p_status = 2
  WHERE p_idx = #{p_idx}
</update>

<select id="totalCount" resultType="int" parameterType="Map">
  	SELECT COUNT(*) FROM paylog
    WHERE p_status = 0 AND m_idx = #{m_idx}
    <if test="searchType != null and searchType == 0">
      AND foodNm LIKE CONCAT('%', #{searchValue}, '%')
    </if>
    <if test="searchType != null and searchType == 1">
      AND restNm LIKE CONCAT('%', #{searchValue}, '%')
    </if>
    <if test="searchType != null and searchType == 2">
      AND p_date LIKE CONCAT('%', #{searchValue}, '%')
    </if>
</select>


<!-- insert -->
<insert id="kakaopay" parameterType="com.kdt.finalproject.vo.PayVO">
		INSERT INTO paylog(m_idx, restCd, foodNm, foodCost, totalCost, p_date, p_status, p_time, p_oNum, restNm, payMethod, aid, tid, cid, p_oderId, foodQn, seq)
    VALUES(#{m_idx}, "restCd", #{foodNm}, #{foodCost}, #{totalCost}, #{p_date}, 0, #{p_time},  #{p_oNum}, #{restNm}, 0, #{aid}, #{tid}, #{cid}, #{p_oderId}, #{foodQn}, #{seq})
</insert>

<insert id="tosspay" parameterType="com.kdt.finalproject.vo.PayVO">
		INSERT INTO paylog(m_idx, restCd, foodNm, foodCost, totalCost, p_date, p_status, p_time, p_oNum, restNm, payMethod, aid, tid, cid, p_oderId, foodQn, seq)
    VALUES(#{m_idx}, "restCd", #{foodNm}, #{foodCost}, #{totalCost}, #{p_date}, 0, #{p_time}, #{p_oNum}, #{restNm}, 1, #{aid}, #{tid}, "cid", #{p_oderId}, #{foodQn}, #{seq})
</insert>

<!-- update -->
<update id="kakaorefund" parameterType="com.kdt.finalproject.vo.PayVO">
    UPDATE paylog SET c_date = #{c_date}, c_time = #{c_time}, p_status = 1 WHERE tid=#{tid}
  </update>
</mapper>